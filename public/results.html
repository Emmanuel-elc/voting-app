<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Poll Results</title>
  <link rel="stylesheet" href="style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <script>
    // Redirect non-admins
    fetch('/auth/check-admin').then(res => {
      if (!res.ok) window.location.href = '/';
    });
  </script>

  <h1>Poll Results</h1>
  <div id="resultsContainer"></div>
  <button onclick="window.print()">üñ®Ô∏è Print Results</button>
  <button id="downloadCsv">‚¨áÔ∏è Download CSV</button>

  <script>
    async function loadResults() {
      const urlParams = new URLSearchParams(window.location.search);
      const pollId = urlParams.get('id');
      if (!pollId) return alert("Poll ID not found");

      const res = await fetch(`/polls/${pollId}`);
      if (!res.ok) return alert("Failed to load poll");

      const poll = await res.json();
      document.title = "Results: " + poll.question;

      const container = document.getElementById('resultsContainer');
      container.innerHTML = `<h2>${poll.question}</h2><canvas id="resultsChart"></canvas>`;

      const ctx = document.getElementById('resultsChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: Object.keys(poll.options),
          datasets: [{
            label: 'Votes',
            data: Object.values(poll.options),
            backgroundColor: 'rgba(75, 192, 192, 0.6)'
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true }
          }
        }
      });

      // Enable CSV download
      document.getElementById('downloadCsv').onclick = () => {
        const csvRows = [
          ['Option', 'Votes'],
          ...Object.entries(poll.options)
        ].map(row => row.join(',')).join('\n');

        const blob = new Blob([csvRows], { type: 'text/csv' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `results-${poll.id}.csv`;
        a.click();
      };
    }

    loadResults();
  </script>
</body>
</html>
